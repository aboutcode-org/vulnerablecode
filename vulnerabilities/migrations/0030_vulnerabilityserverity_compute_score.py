from django.db import migrations

from vulnerabilities.severity_systems import SCORING_SYSTEMS


def compute_score(apps, schema_editor):
    Vuln_severity = apps.get_model('vulnerabilities', 'VulnerabilitySeverity')
    for vuln_severity in Vuln_severity.objects.all():
        if vuln_severity.value and not vuln_severity.scoring_elements:
            try:
                vuln_severity.scoring_elements = SCORING_SYSTEMS[vuln_severity.scoring_system].as_score(vuln_severity.value)
                vuln_severity.save()
            except NotImplementedError:
                pass


class Migration(migrations.Migration):
    dependencies = [
        ('vulnerabilities', '0029_vulnerabilityseverity_scoring_elements'),
    ]

    operations = [
        migrations.RunPython(compute_score, migrations.RunPython.noop),
    ]
