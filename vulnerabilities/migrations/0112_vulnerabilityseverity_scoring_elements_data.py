# Generated by Django 6.0.1 on 2026-01-27 10:41

from django.db import migrations, models


from vulnerabilities.severity_systems import SCORING_SYSTEMS
from cvss.exceptions import CVSS2MalformedError
from cvss.exceptions import CVSS3MalformedError
from cvss.exceptions import CVSS4MalformedError

def backfill_scoring_data(apps, schema_editor):
    VulnerabilitySeverity = apps.get_model('vulnerabilities', 'VulnerabilitySeverity')
    for vs in VulnerabilitySeverity.objects.all():
        if vs.scoring_elements and vs.scoring_system in SCORING_SYSTEMS:
            try:
                vs.scoring_elements_data = SCORING_SYSTEMS[vs.scoring_system].get(
                    vs.scoring_elements
                )
            except (
                CVSS2MalformedError,
                CVSS3MalformedError,
                CVSS4MalformedError,
                NotImplementedError,
                Exception,
            ):
                vs.scoring_elements_data = {}
            vs.save()

class Migration(migrations.Migration):

    dependencies = [
        ('vulnerabilities', '0111_alter_advisoryseverity_scoring_system_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='vulnerabilityseverity',
            name='scoring_elements_data',
            field=models.JSONField(blank=True, default=dict, help_text='The parsed data from the scoring elements.'),
        ),
        migrations.RunPython(backfill_scoring_data, migrations.RunPython.noop),
    ]
