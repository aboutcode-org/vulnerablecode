{% extends "base.html" %}
{% load humanize %}
{% load widget_tweaks %}
{% load static %}
{% load show_cvss %}
{% load url_filters %}

{% block title %}
VulnerableCode Vulnerability Details - {{ vulnerability.vulnerability_id }}
{% endblock %}

{% block content %}
<section class="section pt-0">
    {% include "vulnerability_search_box.html" %}
</section>

{% if vulnerability %}
<section class="section pt-0">
    <div class="details-container">
        <article class="panel is-info panel-header-only">
            <div class="panel-heading py-2 is-size-6">
                Vulnerability details:
                <span class="tag is-white custom">
                    {{ vulnerability.vulnerability_id }}
                </span>
            </div>
        </article>

        <div class="tabs is-boxed" id="tabs">
            <ul>
                <li class="is-active" data-tab="essentials">
                    <a>
                        <span>Essentials</span>
                    </a>
                </li>
                <li data-tab="affected-fixed-by">
                    <a>
                        <span>
                            Affected/Fixed by packages ({{ affected_packages|length }}/{{ fixed_by_packages|length }})
                        </span>
                    </a>
                </li>
                <li data-tab="severities">
                    <a>
                        <span>
                            Severities ({{ severities|length }})
                        </span>
                    </a>
                </li>
                <li data-tab="references">
                    <a>
                        <span>
                            References ({{ references|length }})
                        </span>
                    </a>
                </li>
                <li data-tab="severities-vectors">
                    <a>
                        <span>
                            Severities vectors ({{ severity_vectors|length }})
                        </span>
                    </a>
                </li>

                {% if vulnerability.exploits %}
                    <li data-tab="exploits">
                        <a>
                            <span>
                                Exploits ({{ vulnerability.exploits.count }})
                            </span>
                        </a>
                    </li>
                {% endif %}

                <li data-tab="epss">
                    <a>
                        <span>
                            EPSS
                        </span>
                    </a>
                </li>

                <li data-tab="history">
                    <a>
                        <span>
                            History ({{ history|length }})
                        </span>
                    </a>
                </li>
            </ul>
        </div>
        <div id="tab-content">
            <div class="tab-div is-active" data-content="essentials">
                <div class="tab-nested-div">
                    <table class="table vcio-table width-100-pct mt-2">
                        <tbody>
                            <tr>
                                <td class="two-col-left">Vulnerability ID</td>
                                <td class="two-col-right">{{ vulnerability.vulnerability_id }}</td>
                            </tr>
                            <tr>
                                <td class="two-col-left">Aliases</td>
                                <td class="two-col-right">
                                    {% for alias in aliases %}
                                    {% if alias.url %}
                                    <a href={{ alias.url }} target="_blank">{{ alias }}<i
                                            class="fa fa-external-link fa_link_custom"></i></a>
                                    {% else %}
                                    {{ alias }}
                                    {% endif %}
                                    <br />
                                    {% endfor %}
                                </td>
                            </tr>
                            <tr>
                                <td class="two-col-left">Summary</td>
                                <td class="two-col-right wrap-strings">{{ vulnerability.summary }}
                                </td>
                            </tr>
                            {% if severity_score_range %}
                            <tr>
                                <td class="two-col-left">Severity score range</td>
                                <td class="two-col-right">{{ severity_score_range }}
                                </td>
                                {% endif %}
                            </tr>
                            <tr>
                                <td class="two-col-left">Status</td>
                                <td class="two-col-right">{{ status }}</td>
                            </tr>

                            <tr>
                                <td class="two-col-left"
                                    data-tooltip="Exploitability indicates the likelihood that a vulnerability in a software package 
                                    could be used by malicious actors to compromise systems,
                                    applications, or networks. This metric is determined automatically based on the discovery of known exploits.">
                                    Exploitability</td>
                                <td class="two-col-right wrap-strings">
                                    {{ vulnerability.exploitability }}
                                </td>
                            </tr>

                            <tr>
                                <td class="two-col-left"
                                    data-tooltip="Weighted severity is the highest value calculated by multiplying each severity by its corresponding weight, divided by 10."
                                >Weighted Severity</td>
                                <td class="two-col-right wrap-strings">
                                    {{ vulnerability.weighted_severity }}
                                </td>
                            </tr>

                            <tr>
                                <td class="two-col-left"
                                    data-tooltip="Risk expressed as a number ranging from 0 to 10. It is calculated by multiplying
                                    the weighted severity and exploitability values, capped at a maximum of 10.
                                    "
                                >Risk</td>
                                <td class="two-col-right wrap-strings">
                                    {{ vulnerability.risk_score }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Moved severities to its own tab -->

                <div class="has-text-weight-bold tab-nested-div ml-1 mb-1 mt-6">
                    Affected/Fixed by packages ({{ affected_packages|length }}/{{ fixed_by_packages|length }})
                </div>
                <!-- Rest of the affected/fixed packages section -->
            </div>

            <!-- New Severities Tab -->
            <div class="tab-div content" data-content="severities">
                <table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth gray-header-border">
                    <tr>
                        <th style="width: 160px;"> System </th>
                        <th style="width: 100px;"> Score </th>
                        <th> Found at </th>
                    </tr>
                    {% for severity in severities %}
                    <tr>
                        <td class="wrap-strings">{{ severity.scoring_system }}</td>
                        <td class="wrap-strings">{{ severity.value }}</td>
                        <td class="wrap-strings"><a href="{{ severity.url }}" target="_blank">
                                {{ severity.url }}<i class="fa fa-external-link fa_link_custom"></i></a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3">
                            There are no known severity scores.
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            </div>

            <!-- Rest of the existing tabs -->
            <!-- ... -->
        </div>
    </div>
</section>
{% endif %}

<script src="{% static 'js/main.js' %}" crossorigin="anonymous"></script>

<script>
    function goToTab(tabName) {
        const activeLink = document.querySelector('div.tabs.is-boxed li.is-active');
        const activeTabContent = document.querySelector('div.tab-div.is-active');

        activeLink.classList.remove('is-active');
        activeTabContent.classList.remove('is-active');

        const target_id = document.querySelector(`[data-tab='${tabName}']`);
        const targetTabContent = document.querySelector(`[data-content='${tabName}']`);

        target_id.classList.add('is-active');
        targetTabContent.classList.add('is-active');
    }
</script>

{% endblock %}